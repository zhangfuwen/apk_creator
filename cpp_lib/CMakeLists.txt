# you have to have CMake >= 3.20 to be able to use CMakePresets.json
cmake_minimum_required(VERSION 3.20)
project("MyNativeApp" LANGUAGES C CXX)

message("CMAKE_VERSION: ${CMAKE_VERSION}")
message("CMAKE_ANDROID_NDK: ${CMAKE_ANDROID_NDK}")
message("ANDROID_PLATFORM: ${ANDROID_PLATFORM}")

include_directories(${CMAKE_ANDROID_NDK}/sources/android/native_app_glue)
include_directories(${CMAKE_ANDROID_NDK}/sources/cxx-stl/llvm-libc++/include)
include_directories(
  ${CMAKE_ANDROID_NDK}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include
)

# Find required libraries
find_library(log-lib log)
find_library(android-lib android)
find_library(EGL-lib EGL)
find_library(GLESv3-lib GLESv3)
find_library(OpenSLES-lib OpenSLES)
find_library(camera-lib camera2ndk)
find_library(media-lib mediandk)

# Build native_app_glue (required for NativeActivity) build native_app_glue as a
# static lib
set(${CMAKE_C_FLAGS}, "${CMAKE_C_FLAGS}")
add_library(
  native_app_glue STATIC
  ${ANDROID_NDK}/sources/android/native_app_glue/android_native_app_glue.c
)
# set_target_properties(native_app_glue PROPERTIES LINKER_LANGUAGE CXX)
# set_target_properties(native_app_glue PROPERTIES COMPILE_FLAGS
# "-Wno-error=unused-parameter")

set(CMAKE_SHARED_LINKER_FLAGS
    "${CMAKE_SHARED_LINKER_FLAGS} -u ANativeActivity_onCreate"
)

set(OBOE_ENABLE_OPENSL
    OFF
    CACHE BOOL "Enable OpenSL ES backend"
)

set(OBOE_INCLUDE_DIR ${VCPKG_ROOT}/installed/arm64-android/include)
set(OBOE_LINK_DIR ${VCPKG_ROOT}/installed/arm64-android/lib)

# Main native library
add_library(
  main SHARED
  audio/LatencyTuningCallback.cpp audio/OboeEngine.cpp audio/SoundGenerator.cpp
  main.cpp renderer/eye_renderer.cpp renderer/rectangles_renderer.cpp
)
set_target_properties(main PROPERTIES LINKER_LANGUAGE CXX)
target_include_directories(
  main PRIVATE ${CMAKE_ANDROID_NDK}/sources/android/native_app_glue
               ${OBOE_INCLUDE_DIR} ${CMAKE_SOURCE_DIR}
)
target_link_directories(main PRIVATE ${OBOE_LINK_DIR})
# Extract numeric API level from ANDROID_PLATFORM (e.g., android-24 â†’ 24)
if(ANDROID AND ANDROID_PLATFORM)
    string(REGEX MATCH "[0-9]+" ANDROID_API_NUM "${ANDROID_PLATFORM}")
    message(STATUS "Target Android API Level: ${ANDROID_API_NUM}")

    # Define __ANDROID_API__ manually (usually already set)
    target_compile_definitions(main PRIVATE __ANDROID_API__=${ANDROID_API_NUM})

endif()

# Link libraries
target_link_libraries(
  main
  android
  oboe
  native_app_glue
  ${log-lib}
  ${android-lib}
  ${EGL-lib}
  ${GLESv3-lib}
  ${OpenSLES-lib}
  ${camera-lib}
  ${media-lib}
)
